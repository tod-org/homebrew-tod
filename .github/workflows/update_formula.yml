name: Update Homebrew Formula from tod

# Triggered remotely by 'repository_dispatch' from tod-org/tod
# Also supports manual triggering via workflow_dispatch
on:
  repository_dispatch:
    types: [update-homebrew]

  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to update to (e.g., v1.2.3 or 1.2.3). If blank, use latest release."
        required: false
        type: string

permissions:
  contents: write

jobs:
  update-formula:
    name: Update Formula
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # Decide the version/tag:
      # - If manually triggered with an input tag, normalize it (strip leading 'v')
      # - Otherwise fetch the latest release from tod-org/tod
      - name: Resolve version
        id: resolve_version
        shell: bash
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          set -euo pipefail

          if [[ -n "${INPUT_TAG:-}" ]]; then
            # normalize: accept vX.Y.Z or X.Y.Z
            tag="${INPUT_TAG}"
            version="${tag#v}"
            echo "Using provided tag: ${tag}"
          else
            echo "No tag provided; fetching latest release from tod-org/tod…"
            # Use GitHub API to get the latest tag
            tag="$(curl -fsSL https://api.github.com/repos/tod-org/tod/releases/latest | jq -r .tag_name)"
            if [[ -z "${tag}" || "${tag}" == "null" ]]; then
              echo "Failed to fetch latest tag from tod-org/tod"
              exit 1
            fi
            version="${tag#v}"
            echo "Latest tag: ${tag}"
          fi

          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Run formula updater
        run: |
          ruby scripts/update_formula.rb "${{ steps.resolve_version.outputs.version }}"

      - name: Show diff
        run: git --no-pager diff Formula/tod.rb || true

      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if ! git diff --quiet Formula/tod.rb; then
            echo "✅ Changes detected. Committing…"
            git add Formula/tod.rb
            git commit -m "Update formula to version ${{ steps.resolve_version.outputs.version }}"
            git push
          else
            echo "ℹ️ No changes to commit."
          fi
